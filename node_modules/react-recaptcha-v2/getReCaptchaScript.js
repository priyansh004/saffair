const callbackName = '__ON_RECAPTCHA_LOAD'
let promise = null
let isRequested = false

export default function (locale) {
  if (promise) return promise
  promise = new Promise((resolve, reject) => {
    const ReCaptchaScript = window.grecaptcha

    if (ReCaptchaScript) {
      resolve(ReCaptchaScript)
      return
    }

    if (isRequested) return
    isRequested = true

    const callback = () => {
      resolve(window.grecaptcha)
      delete window[callbackName]
    }

    window[callbackName] = callback

    const script = document.createElement('script')
    script.src = `https://www.google.com/recaptcha/api.js?onload=${callbackName}&render=explicit&hl=${locale}`
    script.async = true

    script.onerror = () => reject(new Error('Load ReCaptcha script error'))

    document.body.appendChild(script)
  })
  return promise
}
